<!DOCTYPE html>
<html lang="en">
<head>
  <!-- ... (head content remains unchanged) ... -->
</head>
<body>
  <!-- Calculator Section -->
  <div class="container">
    <!-- ... (calculator HTML unchanged) ... -->
  </div>

  <!-- Content Section -->
  <div class="container" style="margin-top:20px;">
    <!-- ... (content section unchanged) ... -->
  </div>

  <script>
    // CORRECTED TAX SLABS (2025)
    const taxSlabs = [
      { min: 0, max: 600000, rate: 0 },
      { min: 600001, max: 1200000, rate: 0.05 },
      { min: 1200001, max: 2200000, rate: 0.15 },
      { min: 2200001, max: 3200000, rate: 0.25 },
      { min: 3200001, max: 4100000, rate: 0.30 },
      { min: 4100001, rate: 0.35 } // No upper limit for last slab
    ];

    function formatPKR(num) {
      return 'â‚¨' + Math.abs(Math.round(num)).toLocaleString('en-PK') + 
             (num < 0 ? ' (Credit)' : '');
    }

    function calculateTax() {
      // INPUT SANITIZATION
      const salary = Math.abs(parseFloat(document.getElementById('salary').value)) || 0;
      const otherIncome = Math.abs(parseFloat(document.getElementById('otherIncome').value)) || 0;
      const expenses = Math.abs(parseFloat(document.getElementById('expenses').value)) || 0;
      const liabilities = Math.abs(parseFloat(document.getElementById('liabilities').value)) || 0;

      // VALIDATION
      let errorMsg = "";
      if (expenses > (salary + otherIncome)) {
        errorMsg = "Expenses cannot exceed total income";
      }
      if (errorMsg) {
        document.getElementById('errorMsg').innerText = errorMsg;
        document.getElementById('errorMsg').style.display = 'block';
        document.getElementById('results').style.display = 'none';
        return;
      }
      document.getElementById('errorMsg').style.display = 'none';

      // CALCULATIONS
      const grossIncome = salary + otherIncome;
      const deductible = Math.min(expenses, grossIncome);
      const taxableIncome = Math.max(grossIncome - deductible, 0);

      // TAX CALCULATION LOGIC (FIXED)
      let tax = 0;
      let remainingIncome = taxableIncome;

      for (let slab of taxSlabs) {
        if (remainingIncome <= 0) break;

        // Calculate taxable amount for this slab
        let taxableAmount = slab.max ? 
          Math.min(remainingIncome, slab.max - slab.min + 1) : 
          remainingIncome;

        tax += taxableAmount * slab.rate;
        remainingIncome -= taxableAmount;
      }

      // FINAL TAX
      const finalTax = Math.max(0, tax - liabilities);
      const q = Math.ceil(finalTax / 4);

      // DISPLAY RESULTS
      document.getElementById('grossIncome').innerText = formatPKR(grossIncome);
      document.getElementById('deductible').innerText = formatPKR(deductible);
      document.getElementById('taxableIncome').innerText = formatPKR(taxableIncome);
      document.getElementById('taxAmount').innerText = formatPKR(tax);
      document.getElementById('liabilitiesAmount').innerText = formatPKR(liabilities);
      document.getElementById('finalTax').innerText = formatPKR(finalTax);

      document.getElementById('q1').innerText = formatPKR(q);
      document.getElementById('q2').innerText = formatPKR(q);
      document.getElementById('q3').innerText = formatPKR(q);
      document.getElementById('q4').innerText = formatPKR(finalTax - (q * 3));

      document.getElementById('taxNote').innerText = finalTax <= 0 ? 
        "No tax payable. Your taxable income is below the threshold." : 
        "Please pay your advance tax in four installments as per FBR schedule.";

      document.getElementById('results').style.display = 'block';
    }
  </script>
</body>
</html>
